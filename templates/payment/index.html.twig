{% extends 'base.html.twig' %}

{% block title %}Listado de Pagos{% endblock %}

{% block body %}
<div class="container" style="margin-top: 20px;">
    
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Listado de Pagos</h1>
    <div>
        {# Botón existente de Nuevo Pago #}
        <a href="{{ path('app_payment_new') }}" class="btn btn-success">
            <i class="fas fa-plus-circle"></i> Nuevo Pago
        </a>

        {# --- NUEVO BOTÓN: Reportes de Pagos --- #}
        {# Usamos 'ms-2' para dar un pequeño margen a la izquierda #}
        <a href="{{ path('app_payment_reports') }}" class="btn btn-info text-white ms-2">
            <i class="fas fa-chart-line"></i> Reportes de pagos
        </a>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Filtros de Búsqueda</div>
        <div class="card-body">
        <form method="get" action="{{ path('app_payment_index') }}" class="row g-3">
            
            {# 1. Filtro Cliente #}
            <div class="col-md-3">
                <label class="form-label">Cliente</label>
                <select name="cliente" class="form-select">
                    <option value="">Todos los clientes</option>
                    {% for c in customers %}
                        <option value="{{ c.id }}" {{ filters.cliente == c.id ? 'selected' : '' }}>
                            {{ c.firstName }} {{ c.lastName }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            {# 2. Filtro Staff #}
            <div class="col-md-3">
                <label class="form-label">Atendido por (Staff)</label>
                <select name="staff" class="form-select">
                    <option value="">Todos</option>
                    {% for s in staffMembers %}
                        <option value="{{ s.staffId }}" {{ filters.staff == s.staffId ? 'selected' : '' }}>
                            {{ s.firstName }} {{ s.lastName }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            {# 3. Fechas #}
            <div class="col-md-2">
                <label class="form-label">Desde</label>
                <input type="date" name="fecha_inicio" class="form-control" value="{{ filters.fecha_inicio }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Hasta</label>
                <input type="date" name="fecha_fin" class="form-control" value="{{ filters.fecha_fin }}">
            </div>

            {# 4. Ordenar #}
            <div class="col-md-2">
                <label class="form-label">Ordenar por</label>
                <select name="ordenar" class="form-select">
                    <option value="date_desc" {{ filters.ordenar == 'date_desc' ? 'selected' : '' }}>Fecha (Reciente)</option>
                    <option value="date_asc" {{ filters.ordenar == 'date_asc' ? 'selected' : '' }}>Fecha (Antigua)</option>
                    <option value="amount_desc" {{ filters.ordenar == 'amount_desc' ? 'selected' : '' }}>Mayor Monto</option>
                    <option value="amount_asc" {{ filters.ordenar == 'amount_asc' ? 'selected' : '' }}>Menor Monto</option>
                </select>
            </div>

            {# Botones #}
            <div class="col-12 mt-3">
                <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
                <a href="{{ path('app_payment_index') }}" class="btn btn-secondary">Limpiar</a>
            </div>
        </form>
    </div>
</div>

    {# --- TABLA DE DATOS --- #}
    <div class="card">
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Cliente</th>
                        <th>Staff (Vendedor)</th>
                        <th>Monto</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                {% for payment in payments %}
                    <tr>
                        {# Nombre del Cliente (Relación) #}
                        <td>
                            {{ payment.customer.firstName }} {{ payment.customer.lastName }}
                        </td>

                        {# Nombre del Staff (Relación) #}
                        <td>
                            <span class="badge bg-info text-dark">
                                {{ payment.staff.firstName }}
                            </span>
                        </td>

                        {# Monto #}
                        <td style="font-weight: bold; color: green;">
                            ${{ payment.amount }}
                        </td>

                        {# Fecha con formato #}
                        <td>{{ payment.paymentDate ? payment.paymentDate|date('Y-m-d H:i') : '' }}</td>

                        <td>
                            <a href="{{ path('app_payment_show', {'paymentId': payment.paymentId}) }}" class="btn btn-sm btn-warning">Ver detalles</a>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="6" class="text-center">No se encontraron pagos.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {# --- PAGINACIÓN (Estilo idéntico a tu ejemplo) --- #}
    {# Bloque de Paginación Inteligente #}
<div class="d-flex justify-content-center mt-4 mb-4">
    <div class="btn-group" role="group" aria-label="Paginación">

        {# 1. BOTÓN ANTERIOR #}
        {% if thisPage > 1 %}
            {# 'filters|merge' asegura que no pierdas el cliente seleccionado al retroceder #}
            <a href="{{ path('app_payment_index', filters|merge({page: thisPage - 1})) }}" 
               class="btn btn-outline-primary">
                &laquo; Anterior
            </a>
        {% else %}
            <button type="button" class="btn btn-outline-secondary" disabled>
                &laquo; Anterior
            </button>
        {% endif %}

        {# 2. INDICADOR DE PÁGINA #}
        <button type="button" class="btn btn-primary" disabled>
            Página {{ thisPage }} de {{ maxPages }}
        </button>

        {# 3. BOTÓN SIGUIENTE #}
        {% if thisPage < maxPages %}
            {# Aquí también usamos 'filters|merge' para avanzar sin perder filtros #}
            <a href="{{ path('app_payment_index', filters|merge({page: thisPage + 1})) }}" 
               class="btn btn-outline-primary">
                Siguiente &raquo;
            </a>
        {% else %}
            <button type="button" class="btn btn-outline-secondary" disabled>
                Siguiente &raquo;
            </button>
        {% endif %}

    </div>
</div>

</div>
{% endblock %}